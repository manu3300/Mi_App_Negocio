<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        h1 { text-align: center; color: #34495e; }
        h2 { border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-top: 40px; }
        .form-section { border: 1px solid #bdc3c7; border-radius: 8px; padding: 20px; margin-top: 20px; background-color: #f9f9f9; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 10px 15px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        .btn:hover { background-color: #2980b9; }
        .back-link { display: block; margin-top: 20px; text-align: center; color: #3498db; text-decoration: none; }
        
        .table-container { margin-top: 30px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .values-list { list-style: none; padding: 0; margin: 0; }
        .values-list li { display: inline-block; background-color: #ecf0f1; border-radius: 4px; padding: 4px 8px; margin-right: 5px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>{{ titulo }}</h1>
        
        <div class="table-container">
            <h2>Atributos Existentes</h2>
            {% if atributos_existentes %}
                <table>
                    <thead>
                        <tr>
                            <th>Atributo</th>
                            <th>Valores</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for atributo in atributos_existentes %}
                        <tr>
                            <td>{{ atributo.nombre }}</td>
                            <td>
                                <ul class="values-list">
                                    {% for valor in atributo.valoratributo_set.all %}
                                        <li>{{ valor.valor }}</li>
                                    {% endfor %}
                                </ul>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>No hay atributos creados aún.</p>
            {% endif %}
        </div>

        <div class="form-section">
            <h2>Crear Nuevo Atributo</h2>
            <form method="post" name="crear_atributo_form">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit" class="btn" name="crear_atributo">Guardar Atributo</button>
            </form>
        </div>

        <div class="form-section">
            <h2>Añadir Valores a un Atributo Existente</h2>
            <form method="post" name="agregar_valores_form">
                {% csrf_token %}
                {{ formset.management_form }}
                <p>
                    <label for="id_atributo">Atributo:</label>
                    <select name="atributo" id="id_atributo">
                        {% for atributo in atributos_existentes %}
                            <option value="{{ atributo.pk }}">{{ atributo.nombre }}</option>
                        {% endfor %}
                    </select>
                </p>
                <div id="formset-container">
                    {% for form_valor in formset %}
                        <div class="form-row">
                            {{ form_valor.as_p }}
                        </div>
                    {% endfor %}
                    <div id="empty-form" style="display:none;">
                        <div class="form-row">
                            {{ empty_form.as_p }}
                        </div>
                    </div>
                </div>
                <button type="button" class="btn" id="add-more-values">Añadir más valores</button>
                <button type="submit" class="btn" name="agregar_valores">Guardar Valores</button>
            </form>
        </div>
        
        <a href="{% url 'crear_producto_rapido' %}" class="back-link">← Volver a crear producto</a>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formsetContainer = document.getElementById('formset-container');
            const addButton = document.getElementById('add-more-values');
            const managementForm = document.querySelector('#id_form-TOTAL_FORMS');
            const emptyFormTemplate = document.querySelector('#empty-form');

            if (addButton && formsetContainer && managementForm && emptyFormTemplate) {
                addButton.addEventListener('click', function() {
                    const currentTotal = parseInt(managementForm.value);
                    const newFormHtml = emptyFormTemplate.innerHTML.replace(/__prefix__/g, currentTotal);
                    
                    const newFormWrapper = document.createElement('div');
                    newFormWrapper.innerHTML = newFormHtml;
                    
                    formsetContainer.appendChild(newFormWrapper);
                    
                    managementForm.value = currentTotal + 1;
                });
            } else {
                console.error('Error: No se encontraron los elementos del formset. Revisa los IDs y su existencia en el DOM.');
            }
        });
    </script>
</body>
</html>